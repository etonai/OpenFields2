# Burst Firing Fix - DevCycle 2025_0020
*Created: 2025-06-24 | Status: Planning*

## Overview
This development cycle focuses specifically on implementing correct burst firing functionality in the OpenFields2 tactical combat game. The current burst firing implementation needs to be fixed to match the intended specification.

**Development Cycle Goals:**
- Implement correct burst firing timing using `firingDelay` from weapon stats
- Fix bullet count to use `burstSize` from weapon configuration (ranged-weapons.json)
- Implement proper hit determination: first bullet normal accuracy, subsequent bullets with Quick aiming speed (-20 penalty)
- Ensure proper integration with existing combat systems

**Burst Firing Specification:**
- **Bullet Count**: Exactly `burstSize` bullets (e.g., UZI fires 3 bullets total)
- **Timing**: First bullet normal, subsequent bullets fired every `firingDelay` ticks (e.g., UZI: bullet 2 at +6 ticks, bullet 3 at +12 ticks)
- **Accuracy**: First bullet uses character's current aiming speed, bullets 2+ use Quick aiming speed (-20 accuracy)

**Prerequisites:** 
- DevCycle 19 completed (Platform Integration and Combat Enhancement)
- Burst mode analysis documentation available
- Combat system stabilized with first attack penalty system

**Estimated Complexity:** Medium - Focused debugging and fixing of existing system

## System Analysis

### 1. Burst Firing Implementation ‚è≥ **IN PROGRESS**
- [ ] **Current State Assessment**
  - [ ] Test current burst firing behavior with UZI (burstSize: 3, firingDelay: 6)
  - [ ] Verify timing of subsequent bullets (should be +6, +12 ticks)
  - [ ] Check if burstSize from weapon config is being used correctly
  - [ ] Validate accuracy penalties for bullets 2 and 3 (should use Quick aiming = -20)

- [ ] **Implementation Requirements**
  - [ ] Fix timing to use `firingDelay` instead of `cyclicRate`
  - [ ] Ensure bullet count matches weapon's `burstSize` property
  - [ ] Implement Quick aiming speed (-20 penalty) for bullets 2+
  - [ ] Maintain first bullet using character's current aiming speed

**Analysis Framework:**
- **Systematic Testing**: Test each component of burst firing individually
- **Event Tracing**: Monitor ScheduledEvent queue during burst sequences
- **State Debugging**: Track isAutomaticFiring and burstShotsFired variables
- **Integration Validation**: Ensure compatibility with recent combat system changes

### 2. Core Burst Mechanics Implementation üîß **PENDING**
- [ ] **Timing Implementation**
  - [ ] Change burst timing from `cyclicRate` to `firingDelay`
  - [ ] Fix bullet scheduling: bullet 2 at fireTick + firingDelay, bullet 3 at fireTick + (firingDelay * 2)
  - [ ] Ensure proper timing for all burst-capable weapons
  - [ ] Validate timing matches weapon configuration

- [ ] **Accuracy Implementation**
  - [ ] Implement Quick aiming speed (-20 penalty) for bullets 2+
  - [ ] Preserve character's original aiming speed for first bullet
  - [ ] Ensure accuracy modifiers apply correctly in hit calculations
  - [ ] Test with different starting aiming speeds (Careful, Normal, Quick)

- [ ] **Burst Size Implementation**
  - [ ] Use weapon's `burstSize` property for total bullet count
  - [ ] Ensure burst terminates after exactly `burstSize` bullets
  - [ ] Handle different burst sizes for different weapons
  - [ ] Validate burst completion logic

## Technical Implementation Plan

### Primary Fix Areas

**1. Character Burst State Management**
- File: `src/main/java/combat/Character.java`
- Focus: Lines around 1118-1162 (burst scheduling code)
- Key Variables: `isAutomaticFiring`, `burstShotsFired`, `savedAimingSpeed`

**2. Firing Mode Integration**
- File: `src/main/java/combat/RangedWeapon.java`
- Focus: Firing mode cycling and burst configuration
- Key Methods: `cycleFiringMode()`, burst size validation

**3. Event Scheduling System**
- File: `src/main/java/game/ScheduledEvent.java` integration
- Focus: Proper burst shot event creation and execution
- Key Areas: Event timing, cleanup, and interruption handling

### Specific Implementation Requirements

**A. Timing Correction**
- Replace `cyclicRate` with `firingDelay` for burst shot intervals
- UZI example: bullet 2 at +6 ticks, bullet 3 at +12 ticks (firingDelay = 6)
- Ensure timing calculation: nextShotTick = fireTick + (firingDelay * shotIndex)

**B. Accuracy Implementation**
- First bullet: Use character's current aiming speed (Careful/Normal/Quick)
- Bullets 2+: Force Quick aiming speed (-20 accuracy penalty)
- Integrate with existing hit determination system

**C. Burst Size Configuration**
- Read `burstSize` from weapon JSON configuration
- Schedule exactly `burstSize` total bullets per burst
- Support different burst sizes for different weapons

## Testing Strategy

### 1. Unit Testing Approach
- [ ] **Individual Component Tests**
  - Test burst state transitions in isolation
  - Validate event scheduling mathematics
  - Check ammunition consumption calculations
  - Verify aiming speed transitions

### 2. Integration Testing
- [ ] **End-to-End Burst Scenarios**
  - UZI burst firing: 3 bullets at +0, +6, +12 ticks
  - Burst firing with Careful aiming (first bullet careful, bullets 2-3 quick)
  - Burst firing with Normal aiming (first bullet normal, bullets 2-3 quick)  
  - Burst firing with Quick aiming (all bullets quick)
  - Burst interruption by target loss or ammunition depletion

### 3. Combat System Integration
- [ ] **Compatibility Validation**
  - Burst firing with first attack penalty system
  - Burst firing with very careful aiming
  - Burst firing in different movement states
  - Burst firing with wound modifiers active

## Success Criteria

### Functional Requirements
- [ ] Burst firing mode activates correctly when selected
- [ ] Exactly `burstSize` shots fired (UZI: 3 shots, other weapons: per config)
- [ ] Correct timing using `firingDelay`: UZI bullets at +0, +6, +12 ticks
- [ ] First bullet uses character's current aiming speed
- [ ] Bullets 2+ use Quick aiming speed (-20 accuracy penalty)
- [ ] Ammunition properly consumed (`burstSize` rounds per burst)
- [ ] Burst state properly reset after completion

### Quality Requirements
- [ ] No burst firing crashes or exceptions
- [ ] Proper console logging for burst sequences
- [ ] Clean event queue management (no orphaned events)
- [ ] Consistent behavior across all burst-capable weapons

### Integration Requirements
- [ ] Compatible with first attack penalty system
- [ ] Works with all aiming speeds including very careful
- [ ] Functions correctly with movement penalties
- [ ] Integrates properly with wound system and hesitation

## Implementation Timeline

### Phase 1: Diagnosis (Estimated: 2-4 hours)
1. **Test Current Burst Firing**: Comprehensive testing of existing functionality
2. **Issue Documentation**: Record all observed problems and failure modes
3. **Root Cause Analysis**: Identify primary causes of burst firing failures

### Phase 2: Core Fixes (Estimated: 3-6 hours)
1. **State Management Repair**: Fix burst state variables and transitions
2. **Event Scheduling Correction**: Repair burst shot scheduling logic
3. **Integration Debugging**: Resolve conflicts with recent combat system changes

### Phase 3: Validation (Estimated: 1-2 hours)
1. **Comprehensive Testing**: Test all burst firing scenarios
2. **Integration Validation**: Ensure compatibility with all combat systems
3. **Documentation Update**: Update burst mode analysis with fixes

## Risk Assessment

### Technical Risks
- **Complex State Dependencies**: Medium - Burst firing involves multiple interacting systems
- **Event Timing Precision**: Medium - Precise timing required for realistic burst sequences
- **Integration Complexity**: Low - Recent combat changes may have affected burst mechanics

### Schedule Risks
- **Issue Complexity**: Medium - Unknown depth of current problems
- **Testing Time**: Low - Well-defined test scenarios available

## Quality Assurance

### Code Quality Standards
- [ ] All burst-related code follows project conventions
- [ ] Proper error handling for burst interruption scenarios
- [ ] Clean separation between burst logic and other combat systems
- [ ] Comprehensive logging for debugging burst sequences

### Testing Requirements
- [ ] Manual testing of all burst scenarios
- [ ] Automated testing where applicable
- [ ] Performance validation (no significant overhead)
- [ ] Memory leak detection for event cleanup

---

## Development Workflow

### Commit Message Format
- **Format**: `DC-20: [Burst fix description]`
- **Examples**: 
  - `DC-20: Fix burst shot event scheduling`
  - `DC-20: Repair burst state management in Character.java`
  - `DC-20: Correct ammunition consumption during bursts`

### Testing Commands
```bash
mvn compile                              # Verify compilation
mvn test                                # Run existing tests  
mvn javafx:run                          # Test burst firing in game
```

### Debugging Approach
```bash
# Enable debug mode to trace burst firing
# Use Ctrl+D in game for detailed combat logging
# Monitor console output during burst sequences
# Check event queue state during burst firing
```

---

*This development cycle uses a focused debugging approach to identify and fix specific burst firing issues. The goal is to restore full burst firing functionality with minimal changes to the broader combat system.*